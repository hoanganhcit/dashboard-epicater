<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Company Meal Portal • HTML5 + Bootstrap</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root {
      --bs-primary: #ff9933;
      --bs-secondary: #e5e7eb;
      --bs-blue: #2196F3;
      --spacing: 0.25rem;
    }

    body {
      background-color: #0b0c0f08;
    }

    .card {
      border-radius: 1rem;
      box-shadow: 0 8px 20px rgba(0, 0, 0, .06);
    }

    .calendar-day {
      aspect-ratio: 1/1;
      border-radius: .75rem;
      text-align: left;
      padding: .5rem;
    }

    .calendar-day.selected {
      background: var(--bs-blue);
      color: #fff;
      box-shadow: 0 6px 16px rgba(59, 130, 246, .35);
    }

    .calendar-day.out {
      color: #9aa0a6;
    }

    .calendar-day:not(.selected):hover {
      background: #f2f4f7;
    }

    .h-10 {
      height: calc(var(--spacing) * 10);
    }


    .dot {
      display: inline-block;
      width: .5rem;
      height: .5rem;
      border-radius: 999px;
      background: #10b981;
    }

    .badge-tag {
      font-size: .6rem;
      border: 1px solid #d1d5db;
      color: #374151;
    }

    .rating i {
      color: #fbbf24;
    }

    .tabular-nums {
      font-variant-numeric: tabular-nums;
    }

    .sticky-actions {
      position: sticky;
      bottom: 0;
      background: #fff;
      padding-top: .25rem;
    }

    .search-icon {
      position: absolute;
      left: .5rem;
      top: .5rem;
      opacity: .6
    }

    .search-input {
      padding-left: 2rem;
    }

    .btn-bs-primary {
      --bs-btn-color: #fff;
      --bs-btn-bg: #ff9933;
      --bs-btn-border-color: #ff9933;
      --bs-btn-hover-color: #fff;
      --bs-btn-hover-bg: #e0801f;
      --bs-btn-hover-border-color: #e0801f;
      --bs-btn-focus-shadow-rgb: 49, 132, 253;
      --bs-btn-active-color: #fff;
      --bs-btn-active-bg: #e0801f;
      --bs-btn-active-border-color: #e0801f;
      --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
      --bs-btn-disabled-color: #fff;
      --bs-btn-disabled-bg: #e0801f;
      --bs-btn-disabled-border-color: #e0801f;
      border-radius: 0.375rem;
    }

    .text-xs {
      font-size: 0.75rem;
    }

    .font-medium {
      font-weight: 500;
    }

    .custom-tabs {
      border-bottom: none;
      background-color: #f0f5fa;
      padding: 6px;
      border-radius: 8px;
      display: inline-flex;
      gap: 6px;
    }

    .custom-tabs .nav-link {
      border: none;
      background: transparent;
      color: #4b5563;
      font-weight: 500;
      border-radius: 6px;
      padding: 6px 12px;
      display: flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
      font-size: 0.875rem;
    }

    .custom-tabs .nav-link:hover {
      background-color: #f3f4f6;
      color: #111827;
    }

    .custom-tabs .nav-link.active {
      background-color: white;
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      color: #111827;
      font-weight: 600;
    }

    .btn-remove {
      text-decoration: none;
      font-size: 1rem;
      font-weight: 500;
    }
  </style>
</head>

<body>

  <div class="container py-4 py-md-5">
    <!-- Page header -->
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
      <div>
        <h1 class="h3 fw-bold mb-1">Company Meal Portal</h1>
        <p class="text-muted small mb-0">Plan meals on the calendar and order from curated vendors selected for you.</p>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-secondary text-xs d-flex align-items-center gap-2" data-bs-toggle="modal"
          data-bs-target="#historyModal">
          <i class="bi bi-clock-history"></i><span>Order History</span>
        </button>
        <button class="btn btn-bs-primary text-xs font-medium  d-flex align-items-center gap-2"
          data-bs-toggle="offcanvas" data-bs-target="#cartDrawer" aria-controls="cartDrawer">
          <i class="bi bi-cart"></i>
          <span>Cart (<span id="cartCount">0</span>)</span>
        </button>
      </div>
    </div>

    <!-- Main grid -->
    <div class="row g-4">
      <!-- Calendar -->
      <div class="col-lg-4">
        <div class="card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-calendar3"></i>
                <h2 class="h5 mb-0" id="monthLabel">September 2025</h2>
              </div>
              <div class="btn-group">
                <button class="btn btn-sm btn-outline-secondary" id="prevMonth" aria-label="Previous month">
                  <i class="bi bi-chevron-left"></i>
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="nextMonth" aria-label="Next month">
                  <i class="bi bi-chevron-right"></i>
                </button>
              </div>
            </div>

            <div class="row row-cols-7 g-2 text-center small text-muted fw-semibold mb-2">
              <div class="col">Sun</div>
              <div class="col">Mon</div>
              <div class="col">Tue</div>
              <div class="col">Wed</div>
              <div class="col">Thu</div>
              <div class="col">Fri</div>
              <div class="col">Sat</div>
            </div>
            <div id="calendarGrid" class="d-grid" style="grid-template-columns: repeat(7, 1fr); gap:.5rem;"></div>
            <div class="text-center text-muted small mt-3">Days with a green dot have scheduled orders. Your cart and
              orders save locally.</div>
          </div>
        </div>
      </div>

      <!-- Vendors & Menus -->
      <div class="col-lg-8">
        <div class="card">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row justify-content-between gap-3 mb-2">
              <div>
                <h3 class="h6 mb-1">Menus for <span id="menuDateLabel">Wed, Sep 4</span></h3>
                <div class="text-muted small">Daily picks rotate and are tailored to your saved preferences.</div>
              </div>
              <div class="position-relative" style="width: 280px; max-width: 100%;">
                <i class="bi bi-search search-icon"></i>
                <input id="searchInput" class="form-control h-10 form-control-sm search-input"
                  placeholder="Search vendors or dishes" />
              </div>
            </div>

            <ul class="nav custom-tabs" id="vendorTabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="tab-recommended" data-bs-toggle="tab"
                  data-bs-target="#pane-recommended" type="button" role="tab">Recommended for You</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="tab-all" data-bs-toggle="tab" data-bs-target="#pane-all" type="button"
                  role="tab">All Vendors</button>
              </li>
            </ul>

            <div class="tab-content pt-3">
              <div class="tab-pane fade show active" id="pane-recommended" role="tabpanel">
                <div id="recommendedList" class="row g-3"></div>
              </div>
              <div class="tab-pane fade" id="pane-all" role="tabpanel">
                <div id="allList" class="row g-3"></div>
              </div>
            </div>

            <div id="noResults" class="text-muted small d-none">No vendors match your search.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Order History Modal -->
  <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Order History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="historyBody">
          <!-- Filled by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Drawer -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="cartDrawer" aria-labelledby="cartTitle"
    style="width: 380px; max-width:100vw;">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="cartTitle">Cart • <span id="cartDate"></span></h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <div id="cartItems" class="d-grid gap-2"></div>
      <div class="sticky-actions mt-auto">
        <hr />
        <div class="d-flex justify-content-between small">
          <span>Subtotal</span>
          <strong class="tabular-nums" id="cartSubtotal">$0.00</strong>
        </div>
        <button id="placeOrderBtn" class="btn btn-bs-primary text-xs font-medium w-100 mt-2">Place Order</button>
      </div>
    </div>
  </div>

  <!-- Templates (hidden) -->
  <template id="vendorCardTpl">
    <div class="col-12 col-md-6">
      <div class="card h-100">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
              <h6 class="mb-0 vendor-name">Vendor Name</h6>
              <div class="text-muted small vendor-cuisine">Cuisine</div>
            </div>
            <div class="rating small"><i class="bi bi-star-fill"></i> <span class="vendor-rating">4.6</span></div>
          </div>
          <div class="d-grid gap-2 menu-items"></div>
        </div>
      </div>
    </div>
  </template>

  <template id="menuItemTpl">
    <div class="d-flex justify-content-between align-items-center gap-2 border rounded p-2">
      <div>
        <div class="fw-medium small item-name">Item Name</div>
        <div class="text-muted small item-price">$0.00</div>
        <div class="mt-1 d-flex flex-wrap gap-1 item-tags"></div>
      </div>
      <button class="btn btn-sm btn-bs-primary text-xs font-medium add-btn">Add</button>
    </div>
  </template>

  <template id="cartItemTpl">
    <div class="d-flex align-items-start justify-content-between gap-2 border rounded p-2">
      <div>
        <div class="fw-semibold small cart-item-name">Item</div>
        <div class="text-muted small cart-item-meta">Vendor • $0.00</div>
        <div class="mt-1 d-flex flex-wrap gap-1 cart-item-tags"></div>
      </div>
      <div class="d-flex align-items-center gap-1">
        <button class="btn btn-sm btn-outline-secondary btn-minus" aria-label="decrease">-</button>
        <div class="px-2 text-center tabular-nums cart-item-qty" style="min-width:2ch;">1</div>
        <button class="btn btn-sm btn-outline-secondary btn-plus" aria-label="increase">+</button>
        <button class="btn btn-sm btn-link text-danger btn-remove" aria-label="remove">&times;</button>
      </div>
    </div>
  </template>

  <template id="historyCardTpl">
    <div class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="fw-semibold history-title">Wed, Sep 4 • $00.00</div>
          <span class="badge text-bg-light small">Placed <span class="history-placed">Sep 4, 11:45</span></span>
        </div>
        <div class="d-grid gap-1 history-items"></div>
        <hr class="my-2" />
        <div class="d-flex justify-content-between">
          <span class="fw-semibold">Total</span>
          <span class="fw-semibold history-total">$00.00</span>
        </div>
      </div>
    </div>
  </template>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ======= Data (replace with API later) =======
    const VENDORS = [
      {
        id: "v1", name: "Green Bowl Kitchen", cuisine: "Healthy • Bowls", rating: 4.7, items: [
          { id: "m1", name: "Teriyaki Salmon Bowl", price: 15.5, tags: ["gluten-free"], vendorId: "v1" },
          { id: "m2", name: "Tofu Power Bowl", price: 12.0, tags: ["vegan"], vendorId: "v1" },
          { id: "m3", name: "Chicken Caesar Wrap", price: 11.0, vendorId: "v1" },
        ]
      },
      {
        id: "v2", name: "Pasta & Co.", cuisine: "Italian", rating: 4.5, items: [
          { id: "m4", name: "Chicken Alfredo", price: 14.0, vendorId: "v2" },
          { id: "m5", name: "Pesto Penne (V)", price: 13.25, tags: ["vegetarian"], vendorId: "v2" },
          { id: "m6", name: "Beef Lasagna", price: 15.25, vendorId: "v2" },
        ]
      },
      {
        id: "v3", name: "Taco Loco", cuisine: "Mexican", rating: 4.6, items: [
          { id: "m7", name: "Beef Tacos (3)", price: 12.0, vendorId: "v3" },
          { id: "m8", name: "Chicken Burrito", price: 11.5, vendorId: "v3" },
          { id: "m9", name: "Veggie Quesadilla", price: 10.0, tags: ["vegetarian"], vendorId: "v3" },
        ]
      },
      {
        id: "v4", name: "Sushi Avenue", cuisine: "Japanese", rating: 4.8, items: [
          { id: "m10", name: "Spicy Salmon Roll", price: 9.5, vendorId: "v4" },
          { id: "m11", name: "Dragon Roll", price: 13.5, vendorId: "v4" },
          { id: "m12", name: "Veggie Roll Set", price: 11.0, tags: ["vegan"], vendorId: "v4" },
        ]
      },
      {
        id: "v5", name: "Curry House", cuisine: "Indian", rating: 4.4, items: [
          { id: "m13", name: "Butter Chicken", price: 13.75, vendorId: "v5" },
          { id: "m14", name: "Chana Masala (V)", price: 11.0, tags: ["vegan"], vendorId: "v5" },
          { id: "m15", name: "Lamb Rogan Josh", price: 15.9, vendorId: "v5" },
        ]
      },
    ];

    const USER = { id: "u1", name: "Employee", preferredCuisines: ["Japanese", "Healthy • Bowls", "Italian"] };

    // ======= Local Storage Keys =======
    const LS_ORDERS = "foodPortal.orders.v1";
    const LS_CART = "foodPortal.cart.v1";

    // ======= Utils =======
    const currency = n => n.toLocaleString(undefined, { style: "currency", currency: "USD" });
    const ymd = d => d.toISOString().slice(0, 10);
    const parseISO = s => new Date(s + (s.endsWith("Z") ? "" : "T00:00:00Z"));
    const fmtDate = (d, opts) => new Intl.DateTimeFormat(undefined, opts).format(d);
    const today = new Date();

    function seededShuffle(arr, seed) {
      const a = arr.slice();
      let s = seed % 2147483647;
      const rnd = () => (s = (s * 48271) % 2147483647) / 2147483647;
      for (let i = a.length - 1; i > 0; i--) { const j = Math.floor(rnd() * (i + 1));[a[i], a[j]] = [a[j], a[i]]; }
      return a;
    }

    // ======= State =======
    let currentMonth = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), 1));
    let selectedDate = new Date(Date.UTC(today.getUTCFullYear(), today.getUTCMonth(), today.getUTCDate()));
    let orders = loadOrders();
    let cart = loadCart();

    // ======= Storage =======
    function loadOrders() { try { return JSON.parse(localStorage.getItem(LS_ORDERS) || "[]"); } catch { return []; } }
    function saveOrders() { localStorage.setItem(LS_ORDERS, JSON.stringify(orders)); }
    function loadCart() { try { return JSON.parse(localStorage.getItem(LS_CART) || "[]"); } catch { return []; } }
    function saveCart() { localStorage.setItem(LS_CART, JSON.stringify(cart)); }

    // ======= Calendar =======
    const monthLabel = document.getElementById('monthLabel');
    const calendarGrid = document.getElementById('calendarGrid');
    const prevBtn = document.getElementById('prevMonth');
    const nextBtn = document.getElementById('nextMonth');

    function startOfMonth(d) { return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), 1)); }
    function endOfMonth(d) { return new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth() + 1, 0)); }
    function startOfWeek(d) { const dt = new Date(d); const day = dt.getUTCDay(); dt.setUTCDate(dt.getUTCDate() - day); return dt; }
    function endOfWeek(d) { const dt = new Date(d); const day = dt.getUTCDay(); dt.setUTCDate(dt.getUTCDate() + (6 - day)); return dt; }

    function formatMonthLabel(d) {
      return fmtDate(d, { month: 'long', year: 'numeric' });
    }

    function isSameDay(a, b) { return a.getUTCFullYear() === b.getUTCFullYear() && a.getUTCMonth() === b.getUTCMonth() && a.getUTCDate() === b.getUTCDate(); }
    function isSameMonth(a, b) { return a.getUTCFullYear() === b.getUTCFullYear() && a.getUTCMonth() === b.getUTCMonth(); }

    function ordersByDay() { const map = {}; for (const o of orders) { map[o.dateISO] = (map[o.dateISO] || 0) + 1; } return map; }

    function renderCalendar() {
      monthLabel.textContent = formatMonthLabel(currentMonth);
      calendarGrid.innerHTML = '';
      const monthStart = startOfMonth(currentMonth);
      const monthEnd = endOfMonth(currentMonth);
      const gridStart = startOfWeek(monthStart);
      const gridEnd = endOfWeek(monthEnd);
      const oMap = ordersByDay();

      const days = [];
      for (let d = new Date(gridStart); d <= gridEnd; d.setUTCDate(d.getUTCDate() + 1)) {
        days.push(new Date(d));
      }

      days.forEach(d => {
        const dateISO = ymd(d);
        const btn = document.createElement('button');
        btn.className = 'btn btn-light w-100 calendar-day' + (isSameDay(d, selectedDate) ? ' selected' : '') + (!isSameMonth(d, monthStart) ? ' out' : '');
        btn.setAttribute('aria-label', `Select ${fmtDate(d, { weekday: 'long', month: 'short', day: 'numeric' })}`);
        btn.innerHTML = `
        <div class="d-flex justify-content-between align-items-center small">
          <span class="fw-semibold">${d.getUTCDate()}</span>
          ${oMap[dateISO] ? '<span class="dot" title="Orders placed"></span>' : ''}
        </div>`;
        btn.addEventListener('click', () => { selectedDate = d; renderCalendar(); renderMenus(); updateCartButton(); });
        calendarGrid.appendChild(btn);
      });
    }

    prevBtn.addEventListener('click', () => { currentMonth = new Date(Date.UTC(currentMonth.getUTCFullYear(), currentMonth.getUTCMonth() - 1, 1)); renderCalendar(); });
    nextBtn.addEventListener('click', () => { currentMonth = new Date(Date.UTC(currentMonth.getUTCFullYear(), currentMonth.getUTCMonth() + 1, 1)); renderCalendar(); });

    // ======= Vendors & Menus =======
    const menuDateLabel = document.getElementById('menuDateLabel');
    const recommendedList = document.getElementById('recommendedList');
    const allList = document.getElementById('allList');
    const noResults = document.getElementById('noResults');
    const searchInput = document.getElementById('searchInput');

    function recommendedVendors() {
      const seed = Number(fmtDate(selectedDate, { year: 'numeric' })) + (selectedDate.getUTCMonth() + 1) * 100 + selectedDate.getUTCDate();
      const preferred = VENDORS.filter(v => USER.preferredCuisines.includes(v.cuisine));
      const others = VENDORS.filter(v => !USER.preferredCuisines.includes(v.cuisine));
      const mix = [...seededShuffle(preferred, seed), ...seededShuffle(others, seed + 1)];
      return mix.slice(0, 3);
    }

    function filterVendors(list) {
      const q = searchInput.value.trim().toLowerCase();
      if (!q) return list;
      return list.filter(v => v.name.toLowerCase().includes(q) || v.cuisine.toLowerCase().includes(q) || v.items.some(i => i.name.toLowerCase().includes(q)));
    }

    function renderVendorCard(v) {
      const tpl = document.getElementById('vendorCardTpl');
      const node = tpl.content.cloneNode(true);
      node.querySelector('.vendor-name').textContent = v.name;
      node.querySelector('.vendor-cuisine').textContent = v.cuisine;
      node.querySelector('.vendor-rating').textContent = v.rating.toFixed(1);
      const itemsWrap = node.querySelector('.menu-items');

      v.items.forEach(it => {
        const itTpl = document.getElementById('menuItemTpl');
        const itNode = itTpl.content.cloneNode(true);
        itNode.querySelector('.item-name').textContent = it.name;
        itNode.querySelector('.item-price').textContent = currency(it.price);
        const tagsWrap = itNode.querySelector('.item-tags');
        (it.tags || []).forEach(t => {
          const b = document.createElement('span');
          b.className = 'badge rounded-pill bg-light text-dark border badge-tag';
          b.textContent = t;
          tagsWrap.appendChild(b);
        });
        itNode.querySelector('.add-btn').addEventListener('click', () => addToCart(it));
        itemsWrap.appendChild(itNode);
      });

      return node;
    }

    function renderMenus() {
      menuDateLabel.textContent = fmtDate(selectedDate, { weekday: 'short', month: 'short', day: 'numeric' });

      // Recommended
      recommendedList.innerHTML = '';
      filterVendors(recommendedVendors()).forEach(v => recommendedList.appendChild(renderVendorCard(v)));

      // All
      allList.innerHTML = '';
      filterVendors(VENDORS).forEach(v => allList.appendChild(renderVendorCard(v)));

      const any = recommendedList.children.length + allList.children.length > 0;
      noResults.classList.toggle('d-none', any);
    }

    searchInput.addEventListener('input', () => renderMenus());

    // ======= Cart =======
    const cartCount = document.getElementById('cartCount');
    const cartDate = document.getElementById('cartDate');
    const cartItems = document.getElementById('cartItems');
    const cartSubtotal = document.getElementById('cartSubtotal');
    const placeOrderBtn = document.getElementById('placeOrderBtn');

    function dayCart() { const iso = ymd(selectedDate); return cart.filter(c => c.dateISO === iso); }
    function updateCartButton() { cartCount.textContent = dayCart().reduce((n, c) => n + c.quantity, 0); cartDate.textContent = fmtDate(selectedDate, { month: 'short', day: 'numeric', year: 'numeric' }); }

    function addToCart(item) {
      const dateISO = ymd(selectedDate);
      const idx = cart.findIndex(ci => ci.item.id === item.id && ci.dateISO === dateISO);
      if (idx >= 0) cart[idx].quantity += 1; else cart.push({ item, quantity: 1, dateISO });
      saveCart(); updateCartButton(); renderCart();
    }

    function updateQty(id, dateISO, delta) {
      cart = cart.map(ci => ci.item.id === id && ci.dateISO === dateISO ? { ...ci, quantity: Math.max(0, ci.quantity + delta) } : ci).filter(ci => ci.quantity > 0);
      saveCart(); updateCartButton(); renderCart();
    }

    function removeFromCart(id, dateISO) {
      cart = cart.filter(ci => !(ci.item.id === id && ci.dateISO === dateISO));
      saveCart(); updateCartButton(); renderCart();
    }

    function renderCart() {
      cartItems.innerHTML = '';
      const items = dayCart();
      if (items.length === 0) {
        cartItems.innerHTML = '<div class="text-muted small">No items for this day. Add meals from the menu.</div>';
        cartSubtotal.textContent = currency(0);
        return;
      }
      let total = 0;
      items.forEach(c => {
        const tpl = document.getElementById('cartItemTpl');
        const node = tpl.content.cloneNode(true);
        node.querySelector('.cart-item-name').textContent = c.item.name;
        const vendorName = (VENDORS.find(v => v.id === c.item.vendorId) || {}).name || c.item.vendorId;
        node.querySelector('.cart-item-meta').textContent = vendorName + ' • ' + currency(c.item.price);
        const tagsWrap = node.querySelector('.cart-item-tags');
        (c.item.tags || []).forEach(t => {
          const b = document.createElement('span');
          b.className = 'badge rounded-pill bg-light text-dark border badge-tag';
          b.textContent = t;
          tagsWrap.appendChild(b);
        });
        node.querySelector('.cart-item-qty').textContent = c.quantity;
        node.querySelector('.btn-minus').addEventListener('click', () => updateQty(c.item.id, c.dateISO, -1));
        node.querySelector('.btn-plus').addEventListener('click', () => updateQty(c.item.id, c.dateISO, 1));
        node.querySelector('.btn-remove').addEventListener('click', () => removeFromCart(c.item.id, c.dateISO));
        cartItems.appendChild(node);
        total += c.item.price * c.quantity;
      });
      cartSubtotal.textContent = currency(total);
    }

    placeOrderBtn.addEventListener('click', () => {
      const items = dayCart();
      if (items.length === 0) return;
      const order = {
        id: 'ord_' + Date.now(),
        dateISO: ymd(selectedDate),
        placedAtISO: new Date().toISOString(),
        items: items.map(c => ({ id: c.item.id, name: c.item.name, price: c.item.price, quantity: c.quantity, vendorId: c.item.vendorId })),
        total: items.reduce((s, c) => s + c.item.price * c.quantity, 0)
      };
      orders = [order, ...orders];
      saveOrders();
      cart = cart.filter(c => c.dateISO !== order.dateISO);
      saveCart();
      renderCalendar(); updateCartButton(); renderCart(); renderHistory();
    });

    // ======= History =======
    const historyBody = document.getElementById('historyBody');

    function renderHistory() {
      historyBody.innerHTML = '';
      if (orders.length === 0) { historyBody.innerHTML = '<div class="text-muted small">No orders yet. Add meals to your cart and place an order.</div>'; return; }
      orders.forEach(o => {
        const tpl = document.getElementById('historyCardTpl');
        const node = tpl.content.cloneNode(true);
        node.querySelector('.history-title').textContent = `${fmtDate(parseISO(o.dateISO), { weekday: 'short', month: 'short', day: 'numeric' })} • ${currency(o.total)}`;
        const placed = new Date(o.placedAtISO);
        node.querySelector('.history-placed').textContent = `${fmtDate(placed, { month: 'short', day: 'numeric' })}, ${String(placed.getHours()).padStart(2, '0')}:${String(placed.getMinutes()).padStart(2, '0')}`;
        node.querySelector('.history-total').textContent = currency(o.total);
        const wrap = node.querySelector('.history-items');
        o.items.forEach(it => {
          const row = document.createElement('div');
          const vendorName = (VENDORS.find(v => v.id === it.vendorId) || {}).name || it.vendorId;
          row.className = 'd-flex justify-content-between small';
          row.innerHTML = `<div class="d-flex gap-2 align-items-center"><span class="badge text-bg-light">${vendorName}</span><span>${it.name}</span></div><div class="tabular-nums">${it.quantity} × ${currency(it.price)}</div>`;
          wrap.appendChild(row);
        });
        historyBody.appendChild(node);
      });
    }

    // ======= Init =======
    function init() {
      renderCalendar();
      renderMenus();
      renderCart();
      renderHistory();
      updateCartButton();
    }
    init();
  </script>
</body>

</html>